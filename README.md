# Tsvarana

### About

Tsvarana is a (t)ime (s)eries (var)iance (ana)lysis package written in Python.

Estimates the variance of individual volumes against the median volume in a 4D NIFTI dataset, and outputs relevant metrics and plots. If requested, volumes with variance above a user-specified threshold are nulled by replacement with the average of the previous and following threshold-compliant volumes. This procedure is carried out iteratively, until the variance threshold is satisfied.

Based on Matthew Brett's data diagnostics tool [Tsdiffana](http://imaging.mrc-cbu.cam.ac.uk/imaging/DataDiagnostics). 

Tsvarana differs in two signifcant respects; (1) Tsvarana performs iterative testing and removal of variance threshold violations, and (2) Tsvarana calculates variance between individual volumes and the median volume of the timeseries. This is in contrast to the approach in Tsdiffana, where variance is calculated volume-to-volume in a sliding window approach. The former approach is preferred, as it is more robust to  cases of sustained abnormal voxel intensities spanning consecutive volumes.

**Contributors**

Ivan Alvarez
University of California, Berkeley

### Requirements

* Python3
* numpy
* pandas
* scipy
* nibabel
* bokeh

All of the above are installed as default in [Anaconda](https://www.anaconda.com/).

### Usage

To perform timeseries variance analysis, use

```bash
python tsvarana.py --data <4d_nifti> --output <basename>
```

Input flags

```bash
--data				[string] A 4-dimensional NIFTI file, typically a BOLD timeseries
--output			[string] Basename for output files
--slicedir 		[string] Slice-encode direction; x,y,z (default = z)
--threshold 	[scalar] Variance threshold for binary regressor generation (default = 5) 
--scrub 			[string] 'volume' (default), 'slice', 'off'
--save_var 		[iftrue] Save variance analysis as CSV files (default = false)
--save_reg		[iftrue] Save binary regressors as CSV files (default = false)
--save_varimg [iftrue] Save variance image as NIFTI files (default = false)
```

The following output files are created;

```bash
<output>_scrub.nii.gz
```

If the `--scrub` flag is turned on, a single file is created, containing the volume- or slice-scrubbed timeseries, depending on requested method.

```bash
<output>_volumevar?.csv
<output>_slicevar?.csv
```

Normalised volume-wise and slice-wise variance metrics. One file is outputted for each iteration of the scrubbing procedure, with `?` indicating the iteration number.

```bash
<output>_varimg?.csv
```

Voxelwise variance image. One file is outputted for each iteration of the scrubbing procedure, with `?` indicating the iteration number.

```bash
output>_volumereg.csv
<output>_slicereg.csv
```

Binary regressors for the censored volumes and/or slices.

Once the variance analysis has been performed, a HTML file with summary plots can be generated with 

```bash
python tsvarana_plot.py --input <basename> --output <basename>
```

Where the `--input` flag specifies the basename of output files generated by `tsvarana.py`.

